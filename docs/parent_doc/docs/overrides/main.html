{% extends "base.html" %}

{% block extrahead  %}
    {{ super() }}
    {% if not config.extra.environment.local_deployment %}
        {% include "partials/intel/loader.inc" %}
        {% include "partials/intel/prefetch.inc" %}
    {% endif %}
    {% if page.meta and page.meta.keywords %}
        <meta name="keywords" content="{{ page.meta.keywords }}" />
    {% elif config.extra.environment.site_keywords %}
        <meta name="keywords" content="{{ config.extra.environment.site_keywords }}" />
    {% endif %}
{% endblock %}

{% block header %}
    {% include "partials/intel/en_US/gh_default.inc" %}
    <script defer type="text/javascript" src="https://www.intel.com/content/dam/www/global/wap/performance-config.js" ></script>
    {{ super() }}
    {% include "partials/breadcrumbs.html" %}
{% endblock %}

{% block content %}
    {% if not config.extra.environment.local_deployment %}
        <script type="text/javascript">
            // Configure TMS settings
            window.wapProfile = 'profile-microsite';
            window.wapLocalCode = 'us-en';
            window.wapSection = 'cc-enabling';
            window.wapEnv = 'dev';
            if (window.location.hostname == "cc-enabling.trustedservices.intel.com") {
                window.wapEnv = 'prod';
            } else {
                window.wapEnv = 'dev';
            }
            // Load TMS
            (() => {
                    let url = 'https://www.intel.com/content/dam/www/global/wap/main/wap-microsite.js';
                    let po = document.createElement('script'); po.type = 'text/javascript'; po.async = true; po.src = url;
                    let s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(po, s);
            }) ();
        </script>
    {% endif %}

    {% if page.url_to_print_page %}
        <a href="{{ page.url_to_print_page }}" title="Print Site" class="md-content__button md-icon">
            {% include ".icons/material/printer.svg" %}
        </a>
    {% endif %}

    {{ super() }}
{% endblock content %}

{% block footer  %}
    {{ super() }}

    {% if not config.extra.environment.local_deployment %}
        {% include "partials/intel/en_US/gf_default.inc" %}

        <script type="text/javascript">
            function waitForElm(selector) {
                return new Promise(resolve => {
                    if (document.querySelector(selector)) {
                        return resolve(document.querySelector(selector));
                    }

                    const observer = new MutationObserver(mutations => {
                        if (document.querySelector(selector)) {
                            observer.disconnect();
                            resolve(document.querySelector(selector));
                        }
                    });

                    observer.observe(document.body, {
                        childList: true,
                        subtree: true
                    });
                });
            }

            waitForElm('div.footer-disclaimer > p').then((elm) => {
                footerDisclaimerText = document.querySelector("div.footer-disclaimer > p");
                if (footerDisclaimerText) {
                    footerDisclaimerTextContent = footerDisclaimerText.innerHTML;
                    footerDisclaimerText.innerHTML = footerDisclaimerTextContent.replace('Notices and Disclaimers</a></u>. //', 'Notices and Disclaimers</a></u>. // See <u><a href="/misc/notices_and_disclaimers/">other Notices and Disclaimers</a></u>. //');
                    if (!footerDisclaimerText.innerHTML.includes("other Notices and Disclaimers")) {
                        alert("Can't insert other notices and disclaimers, please contact Intel")
                    }
                } else {
                    alert("Can't find disclaimer footer, please contact Intel")
                }
            });

            // Fix for IGHF + MkDocs Material navigation.instant compatibility
            // Intercept same-page anchor clicks and handle them natively to avoid IGHF corruption
            (function() {
                // Intercept clicks on anchor links before MkDocs Material can handle them
                document.addEventListener('click', function(e) {
                    // Ignore non-primary clicks (middle-click, right-click)
                    if (e.button !== 0) return;

                    // Ignore modified clicks (Ctrl/Cmd/Alt/Shift) - let browser handle (new tab, etc.)
                    if (e.ctrlKey || e.metaKey || e.altKey || e.shiftKey) return;

                    // Find the closest anchor element
                    const link = e.target.closest('a');
                    if (!link) return;

                    // Respect target="_blank" and download attributes - let browser handle normally
                    if (link.target === '_blank' || link.hasAttribute('download')) return;

                    const href = link.getAttribute('href');
                    if (!href) return;

                    // Check if this is a same-page anchor link using robust URL parsing
                    const currentOrigin = window.location.origin;
                    const currentPathname = window.location.pathname.replace(/\/+$/, '');
                    let isSamePageAnchor = false;
                    let anchorId = null;

                    if (href.startsWith('#')) {
                        // Pure fragment link always refers to the current page
                        isSamePageAnchor = true;
                        anchorId = decodeURIComponent(href.slice(1));
                    } else {
                        try {
                            const url = new URL(href, window.location.href);
                            const targetPathname = url.pathname.replace(/\/+$/, '');
                            // Same-page if origin and (normalized) pathname match and a hash is present
                            if (url.origin === currentOrigin && targetPathname === currentPathname && url.hash) {
                                isSamePageAnchor = true;
                                anchorId = decodeURIComponent(url.hash.slice(1));
                            }
                        } catch (err) {
                            // If href is not a valid URL (e.g., mailto:), treat as not a same-page anchor
                        }
                    }

                    if (isSamePageAnchor) {
                        // If we somehow have no anchorId, fall back to default behavior
                        if (anchorId == null) return;

                        // Prevent MkDocs Material's instant navigation from handling this
                        e.preventDefault();
                        e.stopImmediatePropagation();

                        // Scroll to the anchor element, accounting for sticky header
                        const target = document.getElementById(anchorId);
                        if (target) {
                            // Get sticky header height (MkDocs Material uses .md-header)
                            let headerOffset = 0;
                            const header = document.querySelector('.md-header');
                            if (header) {
                                const headerStyle = getComputedStyle(header);
                                if (headerStyle.position === 'sticky' || headerStyle.position === 'fixed') {
                                    headerOffset = header.getBoundingClientRect().height;
                                }
                            }
                            // Add small padding for visual comfort
                            headerOffset += 16;

                            // Calculate target position accounting for header
                            const targetTop = target.getBoundingClientRect().top + window.scrollY - headerOffset;

                            // Use instant scroll to avoid race conditions with focus()
                            window.scrollTo({
                                top: targetTop,
                                behavior: 'auto'
                            });

                            // Update URL after scroll completes
                            history.pushState(null, '', '#' + anchorId);

                            // Move focus to the target for keyboard/screen-reader users
                            if (typeof target.focus === 'function') {
                                if (!target.hasAttribute('tabindex')) {
                                    target.setAttribute('tabindex', '-1');
                                }
                                // Use preventScroll to avoid double-scrolling from focus
                                target.focus({ preventScroll: true });
                            }
                        } else {
                            // Target not found, just update URL
                            history.pushState(null, '', '#' + anchorId);
                        }
                    }
                }, true);  // Use capture phase to intercept before MkDocs Material
            })();
        </script>
    {% endif %}
{% endblock %}
